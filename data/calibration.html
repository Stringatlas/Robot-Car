<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Calibration</title>
    <link rel="stylesheet" href="/common.css">
    <link rel="stylesheet" href="/components/nav.css">
    <link rel="stylesheet" href="/components/console.css">
    <script src="/components/websocket.js"></script>
    <script src="/components/console.js"></script>
    <script src="calibration.js"></script>

    <style>
        /* Calibration page-specific styles only */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Calibration instructions styling */
        details .instructions {
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        details .instructions strong {
            color: #ff9800;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Main Content Column -->
        <div class="main-content">
            <nav>
                <div class="nav-content">
                    <a href="/" class="inactive">Control</a>
                    <a href="/calibration.html" class="active">Calibration</a>
                </div>
            </nav>
            
            <h1 style="text-align: center; margin: 20px 0;">Motor Calibration & Tuning</h1>
        
        <!-- Direct Motor Control -->
        <div class="control-panel">
            <h2>Direct Motor Control</h2>
            <p class="text-muted mb-15" style="font-size: 14px;">Directly command motor powers for basic testing (-1 to 1 range)</p>
            <div class="config">
                <div class="config-item">
                    <label>Left Motor Power (-1 to 1):</label>
                    <input type="number" id="left-motor-input" value="0" min="-1" max="1" step="0.1">
                </div>
                <div class="config-item">
                    <label>Right Motor Power (-1 to 1):</label>
                    <input type="number" id="right-motor-input" value="0" min="-1" max="1" step="0.1">
                </div>
            </div>
            <div class="mt-15">
                <button class="button" onclick="setMotorPowers()">Set Motor Powers</button>
                <button class="button stop" onclick="stopMotors()">Stop Motors</button>
            </div>
        </div>
        
        <!-- Manual Velocity Feedforward Tuning -->
        <div class="control-panel">
            <h2>Manual Velocity Feedforward Tuning</h2>
            <p class="text-muted mb-15" style="font-size: 14px;">Manually tune feedforward gain and deadzone parameters</p>
            
            <details class="mb-15">
                <summary>Tuning Instructions</summary>
                <div class="instructions">
                    <strong>Step 1: Tune Deadzone</strong><br>
                    1. Click "Zero" to set gain to 0<br>
                    2. Set deadzone to 0<br>
                    3. Slowly increase deadzone until wheels just barely start spinning<br>
                    4. Add 5-10 PWM as margin<br><br>
                    
                    <strong>Step 2: Tune Gain</strong><br>
                    1. Set deadzone to value from Step 1<br>
                    2. Command velocity (try 20 cm/s)<br>
                    3. Wait 2 seconds for steady state<br>
                    4. If error is positive ‚Üí increase gain<br>
                    5. If error is negative ‚Üí decrease gain<br>
                    6. Repeat until error ‚âà 0
                </div>
            </details>
            
            <div class="config">
                <div class="config-item">
                    <label>Feedforward Gain (PWM per cm/s):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="ff-gain-slider" min="0" max="10" step="0.1" value="2.0" 
                               style="flex: 1;" oninput="updateFFGainDisplay()">
                        <span id="ff-gain-value" style="min-width: 50px;">2.0</span>
                    </div>
                </div>
                <div class="config-item">
                    <label>Deadzone (PWM):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="deadzone-slider" min="0" max="100" step="1" value="30" 
                               style="flex: 1;" oninput="updateDeadzoneDisplay()">
                        <span id="deadzone-value" style="min-width: 50px;">30</span>
                    </div>
                </div>
                <div class="config-item">
                    <label>Target Velocity (cm/s):</label>
                    <input type="number" id="velocity-input" value="0" min="-100" max="100" step="5">
                </div>
            </div>
            
            <div class="mt-15">
                <button class="button" onclick="setFFGain()">Set Gain</button>
                <button class="button" onclick="zeroGain()">Zero Gain</button>
                <button class="button" onclick="setDeadzone()">Set Deadzone</button>
                <button class="button" onclick="setVelocity()">Set Velocity</button>
                <button class="button stop" onclick="stopVelocity()">Stop</button>
            </div>
            
            <div class="status" id="velocityStatus">
                Velocity Tracking - Left Error: 0.0 cm/s | Right Error: 0.0 cm/s
            </div>
        </div>
        
        <!-- Configuration Manager - All Parameters -->
        <div class="control-panel">
            <h2>üõ†Ô∏è Configuration Manager</h2>
            <p class="text-muted mb-15" style="font-size: 14px;">
                Manage all robot controller parameters - saved to persistent storage on robot
            </p>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="button" onclick="loadConfigFromRobot()" style="flex: 1;">üì• Load from Robot</button>
                <button class="button" onclick="saveConfigToRobot()" style="flex: 1;">üíæ Save to Robot</button>
                <button class="button secondary" onclick="resetConfigToDefaults()" style="flex: 1;">üîÑ Reset to Defaults</button>
            </div>
            
            <details class="mb-15">
                <summary>üìñ About Configuration System</summary>
                <div class="instructions">
                    <strong style="color: #ff9800;">Persistent Storage:</strong><br>
                    All configuration parameters are saved to the robot's flash memory (LittleFS) and persist across reboots.<br><br>
                    
                    <strong>Parameter Groups:</strong><br>
                    ‚Ä¢ <strong>Feedforward Control:</strong> Linear gain and deadzone for basic velocity control<br>
                    ‚Ä¢ <strong>PID Control:</strong> Proportional, Integral, Derivative gains for closed-loop velocity tracking<br>
                    ‚Ä¢ <strong>Polynomial Mapping:</strong> Cubic regression coefficients for accurate non-linear motor modeling<br><br>
                    
                    <strong>Workflow:</strong><br>
                    1. Calibrate parameters using tools below<br>
                    2. Enter values in this section<br>
                    3. Click "Save to Robot" to persist configuration<br>
                    4. Click "Load from Robot" to restore saved values
                </div>
            </details>
            
            <div style="display: grid; gap: 20px;">
                <!-- Feedforward Parameters -->
                <div style="border: 1px solid #555; padding: 15px; border-radius: 5px;">
                    <h3 style="color: #4CAF50; margin-bottom: 10px;">‚ö° Feedforward Control</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="color: #ccc; font-size: 13px;">Feedforward Gain (PWM per cm/s):</label>
                            <input type="number" id="config_feedforwardGain" step="0.1" value="3.0" 
                                   style="width: 100%; padding: 5px; background: #2a2a2a; border: 1px solid #555; color: #fff;">
                        </div>
                        <div>
                            <label style="color: #ccc; font-size: 13px;">Deadzone PWM:</label>
                            <input type="number" id="config_deadzonePWM" step="1" value="60" 
                                   style="width: 100%; padding: 5px; background: #2a2a2a; border: 1px solid #555; color: #fff;">
                        </div>
                    </div>
                </div>
                
                <!-- PID Parameters -->
                <div style="border: 1px solid #555; padding: 15px; border-radius: 5px;">
                    <h3 style="color: #4CAF50; margin-bottom: 10px;">üéØ PID Control</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="color: #ccc;">
                            <input type="checkbox" id="config_pidEnabled">
                            <strong>Enable PID Controller</strong>
                        </label>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="color: #ccc; font-size: 13px;">Kp (Proportional):</label>
                            <input type="number" id="config_pidKp" step="0.01" value="0.0" 
                                   style="width: 100%; padding: 5px; background: #2a2a2a; border: 1px solid #555; color: #fff;">
                        </div>
                        <div>
                            <label style="color: #ccc; font-size: 13px;">Ki (Integral):</label>
                            <input type="number" id="config_pidKi" step="0.01" value="0.0" 
                                   style="width: 100%; padding: 5px; background: #2a2a2a; border: 1px solid #555; color: #fff;">
                        </div>
                        <div>
                            <label style="color: #ccc; font-size: 13px;">Kd (Derivative):</label>
                            <input type="number" id="config_pidKd" step="0.01" value="0.0" 
                                   style="width: 100%; padding: 5px; background: #2a2a2a; border: 1px solid #555; color: #fff;">
                        </div>
                    </div>
                </div>
                
                <!-- Polynomial Mapping Parameters -->
                <div style="border: 1px solid #555; padding: 15px; border-radius: 5px;">
                    <h3 style="color: #4CAF50; margin-bottom: 10px;">üìà Polynomial Velocity Mapping</h3>
                    <div style="margin-bottom: 10px;">
                        <label style="color: #ccc;">
                            <input type="checkbox" id="config_polynomialEnabled">
                            <strong>Enable Polynomial Mapping</strong> (uses cubic regression instead of linear feedforward)
                        </label>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <!-- Velocity to PWM Polynomial -->
                        <div>
                            <h4 style="color: #888; margin: 10px 0 5px 0; font-size: 12px;">Velocity ‚Üí PWM Control (PWM = a‚ÇÄ + a‚ÇÅ¬∑v + a‚ÇÇ¬∑v¬≤ + a‚ÇÉ¬∑v¬≥)</h4>
                            <div style="display: grid; gap: 6px;">
                                <div>
                                    <label style="color: #999; font-size: 12px;">a‚ÇÄ (constant):</label>
                                    <input type="number" id="config_vel2pwm_a0" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">a‚ÇÅ (linear):</label>
                                    <input type="number" id="config_vel2pwm_a1" step="0.0001" value="1.0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">a‚ÇÇ (quadratic):</label>
                                    <input type="number" id="config_vel2pwm_a2" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">a‚ÇÉ (cubic):</label>
                                    <input type="number" id="config_vel2pwm_a3" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- PWM to Velocity Polynomial -->
                        <div>
                            <h4 style="color: #888; margin: 10px 0 5px 0; font-size: 12px;">PWM ‚Üí Velocity Forward Model (v = b‚ÇÄ + b‚ÇÅ¬∑p + b‚ÇÇ¬∑p¬≤ + b‚ÇÉ¬∑p¬≥)</h4>
                            <div style="display: grid; gap: 6px;">
                                <div>
                                    <label style="color: #999; font-size: 12px;">b‚ÇÄ (constant):</label>
                                    <input type="number" id="config_pwm2vel_b0" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">b‚ÇÅ (linear):</label>
                                    <input type="number" id="config_pwm2vel_b1" step="0.0001" value="1.0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">b‚ÇÇ (quadratic):</label>
                                    <input type="number" id="config_pwm2vel_b2" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                                <div>
                                    <label style="color: #999; font-size: 12px;">b‚ÇÉ (cubic):</label>
                                    <input type="number" id="config_pwm2vel_b3" step="0.0001" value="0" 
                                           style="width: 100%; padding: 4px; background: #2a2a2a; border: 1px solid #555; color: #fff; font-size: 13px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="status" id="configStatus" style="margin-top: 15px;">
                Ready to load or save configuration
            </div>
        </div>
        
        <!-- Automatic Voltage Sweep Calibration -->
        <div class="control-panel">
            <h2>Automatic Voltage Sweep Calibration</h2>
            <p style="color: #888; font-size: 14px; margin-bottom: 15px;">Automatically sweep through PWM values to characterize motor response</p>
            <h3 style="color: #ccc; margin-top: 15px;">Configuration</h3>
            <div class="config">
                <div class="config-item">
                    <label>Start PWM:</label>
                    <input type="number" id="startPWM" value="0" min="0" max="255">
                </div>
                <div class="config-item">
                    <label>End PWM:</label>
                    <input type="number" id="endPWM" value="255" min="0" max="255">
                </div>
                <div class="config-item">
                    <label>Step Size:</label>
                    <input type="number" id="stepSize" value="5" min="1" max="50">
                </div>
                <div class="config-item">
                    <label>Hold Time (ms):</label>
                    <input type="number" id="holdTime" value="2000" min="500" max="10000">
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="button" id="startLeft" onclick="startCalibration('left')">Start Left Motor</button>
                <button class="button" id="startRight" onclick="startCalibration('right')">Start Right Motor</button>
                <button class="button" id="startBoth" onclick="startCalibration('both')">Start Both Motors</button>
                <button class="button stop" id="stopBtn" onclick="stopCalibration()" disabled>Stop</button>
            </div>
            
            <div class="status" id="status">
                Status: Ready
            </div>
        </div>
        
        <!-- PID Autotuner -->
        <div class="control-panel">
            <h2>PID Autotuner (Step Response)</h2>
            <p style="color: #888; font-size: 14px; margin-bottom: 15px;">Automatically tune PID gains using step response analysis</p>
            
            <details style="margin-bottom: 15px; padding: 10px; background: #333; border-radius: 5px;">
                <summary style="cursor: pointer; color: #4CAF50; font-weight: bold;">üìñ How It Works</summary>
                <div style="margin-top: 10px; font-size: 13px; color: #ccc; line-height: 1.6;">
                    <strong style="color: #ff9800;">Step Response Method:</strong><br>
                    1. Starts at 0 velocity, then commands a step to target velocity<br>
                    2. Measures response characteristics with feedforward only (no PID)<br>
                    3. Analyzes: rise time, overshoot, settling time, steady-state error<br>
                    4. Calculates PID gains based on Cohen-Coon method:<br>
                    &nbsp;&nbsp;‚Ä¢ Kp based on steady-state error (tighter tracking)<br>
                    &nbsp;&nbsp;‚Ä¢ Ki to eliminate steady-state error<br>
                    &nbsp;&nbsp;‚Ä¢ Kd to reduce overshoot and improve response<br><br>
                    
                    <strong style="color: #ff9800;">Advantages:</strong><br>
                    ‚Ä¢ Fast: Only 5-8 seconds per test<br>
                    ‚Ä¢ Works with existing feedforward controller<br>
                    ‚Ä¢ Robot stays in one place (minimal movement)<br>
                    ‚Ä¢ Gives conservative, stable gains<br><br>
                    
                    <strong style="color: #ff9800;">Prerequisites:</strong><br>
                    ‚Ä¢ Feedforward gain and deadzone must be tuned first<br>
                    ‚Ä¢ PID should be disabled during test
                </div>
            </details>
            
            <div class="config">
                <div class="config-item">
                    <label>Target Velocity (cm/s):</label>
                    <input type="number" id="autotune-velocity" value="20" min="10" max="50" step="5">
                </div>
                <div class="config-item">
                    <label>Test Duration (seconds):</label>
                    <input type="number" id="test-duration" value="5" min="3" max="10" step="1">
                </div>
                <div class="config-item">
                    <label>Aggressiveness (0.5-2.0):</label>
                    <input type="number" id="tune-aggressiveness" value="1.0" min="0.5" max="2.0" step="0.1">
                    <small style="display: block; color: #888; font-size: 11px; margin-top: 3px;">0.5=conservative, 1.0=balanced, 2.0=aggressive</small>
                </div>
                <div class="config-item">
                    <label>Motor to Tune:</label>
                    <select id="autotune-motor" style="width: 100%; padding: 8px; background: #333; border: 1px solid #555; border-radius: 4px; color: #fff;">
                        <option value="left">Left Motor</option>
                        <option value="right">Right Motor</option>
                        <option value="both">Both Motors</option>
                    </select>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="button" id="startAutotune" onclick="startPIDAutotune()">Start Autotuning</button>
                <button class="button stop" id="stopAutotune" onclick="stopPIDAutotune()" disabled>Stop Autotuning</button>
            </div>
            
            <div class="status" id="autotuneStatus">
                Status: Ready to autotune
            </div>
            
            <div id="autotuneResults" style="background: #333; padding: 15px; border-radius: 5px; margin-top: 15px; display: none;">
                <h3 style="color: #4CAF50; margin-top: 0;">Autotuned PID Gains</h3>
                <div id="autotuneResultsContent" style="font-family: monospace; font-size: 13px; line-height: 1.8;"></div>
                <button class="button" onclick="applyAutotuneGains()" style="margin-top: 10px;">Apply Gains</button>
            </div>
        </div>

        <div class="chart-container">
            <h2>PWM vs Velocity (Voltage Sweep)</h2>
            <canvas id="chart" width="800" height="400"></canvas>
        </div>

        <div class="control-panel">
            <h2>PID Velocity Tuning</h2>
            <div class="config">
                <div class="config-item">
                    <label>Kp (Proportional):</label>
                    <input type="number" id="pidKp" value="1.0" step="0.1" min="0">
                </div>
                <div class="config-item">
                    <label>Ki (Integral):</label>
                    <input type="number" id="pidKi" value="0.0" step="0.01" min="0">
                </div>
                <div class="config-item">
                    <label>Kd (Derivative):</label>
                    <input type="number" id="pidKd" value="0.0" step="0.01" min="0">
                </div>
                <div class="config-item">
                    <label>Target Velocity (cm/s):</label>
                    <input type="number" id="targetVel" value="20" step="1">
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="button" onclick="updatePIDGains()">Update PID Gains</button>
                <button class="button" onclick="togglePID()" id="pidToggle">Enable PID</button>
                <button class="button" onclick="setTargetVelocity()">Set Velocity</button>
                <button class="button stop" onclick="stopMotors()">Stop Motors</button>
            </div>
            
            <div class="status" id="pidStatus">
                PID Status: Disabled | Left Error: 0.0 cm/s | Right Error: 0.0 cm/s
            </div>
        </div>

        <div class="data-table">
            <h2>Calibration Data</h2>
            <div class="export-buttons">
                <button class="button" onclick="exportCSV()">Export CSV</button>
                <button class="button" onclick="exportJSON()">Export JSON</button>
                <button class="button" onclick="calculateModel()">Calculate Model</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>PWM</th>
                        <th>Left Velocity (cm/s)</th>
                        <th>Right Velocity (cm/s)</th>
                    </tr>
                </thead>
                <tbody id="dataTable">
                    <!-- Data rows will be inserted here -->
                </tbody>
            </table>
        </div>
        </div>
        
        <!-- Console Sidebar -->
        <div class="console-sidebar">
            <div class="console-container">
                <div class="console-header">
                    <h2>System Console</h2>
                    <button class='button secondary' onclick='clearConsole()' style="padding: 5px 15px; font-size: 12px;">Clear</button>
                </div>
                <div id="console" class="console">
                    <div class="text-muted">Waiting for telemetry...</div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
